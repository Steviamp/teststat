@inherits LayoutComponentBase
@using UCStatistics.Shared.DTOs
@using UCStatistics.Services
@using UCStatistics.Components.Filters
@using MudBlazor
@inject IDialogService DialogService
@inject ReportService ReportService

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudText Typo="Typo.h6">UC Statistics</MudText>
        <MudSpacer />

        <!-- Navigation Menu -->
        <MudButton Href="/historical"
                   Variant="@GetVariant("/historical")"
                   Color="Color.Inherit"
                   StartIcon="@Icons.Material.Filled.BarChart"
                   Class="mr-2">
            Historical
        </MudButton>

        <MudButton Href="/servicesummary"
                   Variant="@GetVariant("/servicesummary")"
                   Color="Color.Inherit"
                   StartIcon="@Icons.Material.Filled.List"
                   Class="mr-2">
            Service Summary
        </MudButton>

        <MudButton Href="/live"
                   Variant="@GetVariant("/live")"
                   Color="Color.Inherit"
                   StartIcon="@Icons.Material.Filled.AccessTime"
                   Class="mr-2">
            Live
        </MudButton>

        <MudButton Href="/settings"
                   Variant="@GetVariant("/settings")"
                   Color="Color.Inherit"
                   StartIcon="@Icons.Material.Filled.Settings"
                   Class="mr-4">
            Settings
        </MudButton>

        <!-- Filter Button -->
        <MudIconButton Icon="@Icons.Material.Filled.FilterList"
                       Color="Color.Inherit"
                       OnClick="OpenFilterDialog"
                       Title="Open Filters" />
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
            <CascadingValue Value="GlobalFilterCriteria">
                @Body
            </CascadingValue>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private FilterCriteria GlobalFilterCriteria { get; set; } = new FilterCriteria
        {
            DateFrom = DateTime.Today.AddDays(-7),
            DateTo = DateTime.Today,
            Level2Nr = null,
            Level3Nr = null,
            OfficeNr = null
        };

    private List<OfficeInfo> OfficesList { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            OfficesList = (await ReportService.GetOfficesAsync()).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading offices: {ex.Message}");
        }
    }

    private Variant GetVariant(string href)
    {
        return Navigation.Uri.Contains(href) ? Variant.Filled : Variant.Text;
    }

    private async Task OpenFilterDialog()
    {
        var parameters = new DialogParameters<FilterDialog>
        {
            { x => x.FilterCriteria, new FilterCriteria
                {
                    DateFrom = GlobalFilterCriteria.DateFrom,
                    DateTo = GlobalFilterCriteria.DateTo,
                    Level2Nr = GlobalFilterCriteria.Level2Nr,
                    Level3Nr = GlobalFilterCriteria.Level3Nr,
                    OfficeNr = GlobalFilterCriteria.OfficeNr
                }
            },
            { x => x.Areas, OfficesList }
        };

        var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

        var dialog = await DialogService.ShowAsync<FilterDialog>("Filter Options", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is FilterCriteria newCriteria)
        {
            GlobalFilterCriteria = newCriteria;
            StateHasChanged();
        }
    }
}