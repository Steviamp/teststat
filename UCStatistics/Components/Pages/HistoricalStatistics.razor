@rendermode InteractiveServer
@page "/historical"

@using System
@using System.Collections.Generic
@using System.Linq
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using UCStatistics.Components.Filters
@using UCStatistics.Services
@using UCStatistics.Shared.DTOs
@using UCStatistics.Components.Tables
@using MudBlazor

@inject ReportService ReportService
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ExcelExportService ExcelService

<MudThemeProvider />
<MudSnackbarProvider MaxDisplayedSnackbars="3" PreventDuplicates="true" />
<MudDialogProvider />
<MudPopoverProvider />

<PageTitle>Historical Statistics</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Historical Statistics</MudText>

<!-- Filter Component -->
<FilterComponent 
    Criteria="@criteria"
    CriteriaChanged="@OnCriteriaChanged"
    OfficesList="@officesList"
    ServicesList="@servicesList"
    ShowDateFilters="true"
    ShowServiceFilter="@IsServiceTabActive" />

<MudTabs Rounded="true" ActivePanelIndexChanged="@(index => OnTabChanged(index))">
    <MudTabPanel Text="By Branch">
        <div class="d-flex justify-space-between align-center mb-3">
            <MudText Typo="Typo.h6">Branch Statistics</MudText>
            <div class="d-flex gap-2">
                <MudButton Color="Color.Success"
                           Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Download"
                           OnClick="ExportBranchData"
                           Disabled="!(data?.Any() ?? false)">
                    Export to Excel
                </MudButton>
                <MudButton Color="Color.Success"
                           Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Download"
                           OnClick="ExportIndividualTicketsData"
                           Disabled="!(data?.Any() ?? false)">
                    Export Individual tickets to Excel
                </MudButton>
            </div>
        </div>
        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (data?.Any() ?? false)
        {
            <SummaryTable Data="data" />
        }
        else
        {
            <MudAlert Severity="Severity.Warning">No data for selected filters.</MudAlert>
        }
    </MudTabPanel>

    <MudTabPanel Text="By Service">
        <div class="d-flex justify-space-between align-center mb-3">
            <MudText Typo="Typo.h6">Service Statistics</MudText>
            <MudButton Color="Color.Success"
                       Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="ExportServiceData"
                       Disabled="!(serviceData?.Any() ?? false)">
                Export to Excel
            </MudButton>
        </div>
        @if (isServiceLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (serviceData?.Any() ?? false)
        {
            <ServiceSummaryTable Data="serviceData" />
        }
        else
        {
            <MudAlert Severity="Severity.Warning">No service data for selected filters.</MudAlert>
        }
    </MudTabPanel>
</MudTabs>

@code {
    private int activeTabIndex = 0;
    private bool IsServiceTabActive => activeTabIndex == 1;
    private List<OfficeInfo> officesList = new();
    private List<ServiceInfo> servicesList = new();
    
    private FilterCriteria criteria = new FilterCriteria
    {
        DateFrom = DateTime.Today.AddDays(-7),
        DateTo = DateTime.Today
    };

    private IEnumerable<SummaryDto> data;
    private bool isLoading;

    private IEnumerable<ServiceSummaryDto> serviceData;
    private bool isServiceLoading;

    protected override async Task OnInitializedAsync()
    {
        officesList = (await ReportService.GetOfficesAsync()).ToList();
        servicesList = (await ReportService.GetServicesAsync()).ToList();
        await LoadData();
    }

    // Event handler for filter changes
    private async Task OnCriteriaChanged(FilterCriteria newCriteria)
    {
        criteria = newCriteria;
        await LoadCurrentTab();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        data = await ReportService.GetHistoricalAsync(criteria);

        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadServiceData()
    {
        isServiceLoading = true;
        StateHasChanged();

        serviceData = await ReportService.GetServiceSummaryAsync(criteria);

        isServiceLoading = false;
        StateHasChanged();
    }

    private async Task LoadCurrentTab()
    {
        if (activeTabIndex == 0)
            await LoadData();
        else
            await LoadServiceData();
    }

    private async Task OnTabChanged(int index)
    {
        activeTabIndex = index;
        await LoadCurrentTab();
    }

    private async Task ExportBranchData()
    {
        try
        {
            var excelData = await ReportService.ExportSummaryToExcelAsync(criteria);
            var fileName = $"Branch_Summary_{criteria.DateFrom:yyyy-MM-dd}_to_{criteria.DateTo:yyyy-MM-dd}.xlsx";
            await DownloadFileAsync(excelData, fileName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Export error: {ex.Message}");
        }
    }

    private async Task ExportIndividualTicketsData()
    {
        try
        {
            var excelData = await ReportService.ExportIndividualTicketsToExcelAsync(criteria);
            var fileName = $"Tickets_Summary_{criteria.DateFrom:yyyy-MM-dd}_to_{criteria.DateTo:yyyy-MM-dd}.xlsx";
            await DownloadFileAsync(excelData, fileName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Export error: {ex.Message}");
        }
    }

    private async Task ExportServiceData()
    {
        try
        {
            var excelData = await ReportService.ExportServiceSummaryToExcelAsync(criteria);
            var fileName = $"Service_Summary_{criteria.DateFrom:yyyy-MM-dd}_to_{criteria.DateTo:yyyy-MM-dd}.xlsx";
            await DownloadFileAsync(excelData, fileName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Export error: {ex.Message}");
        }
    }

    private async Task DownloadFileAsync(byte[] fileData, string fileName)
    {
        var base64 = Convert.ToBase64String(fileData);
        await JSRuntime.InvokeVoidAsync("downloadFile", base64, fileName);
    }
}